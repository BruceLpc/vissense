/*! { "name": "vissense", "version": "0.1.3", "copyright": "(c) 2014 tbk" } */!function(a,b){"use strict";"function"==typeof define&&define.amd?define([],function(){return b(a,a.document)}):"object"==typeof exports?module.exports=b(a,a.document):a.VisSense=b(a,a.document)}(this,function(a,b,c){"use strict";function d(a,b){return function(){return(k(a)?a():a)?b():c}}function e(a,b,c){for(var d=-1,e=Object.keys(b),f=e.length;++d<f;){var g=e[d];a[g]=c?c(a[g],b[g],g,a,b):b[g]}return a}function f(){}function g(a){return a}function h(){return(new Date).getTime()}function i(b){return a.setTimeout(function(){b()},0)}function j(a){var b=typeof a;return!!a&&("function"===b||a&&"object"===b)}function k(a){return"function"==typeof a||!1}function l(a){return a&&1===a.nodeType||!1}function m(a,b){if(!j(a))return b;for(var c=Object.keys(b),d=0,e=c.length;e>d;d++){var f=c[d];void 0===a[f]&&(a[f]=b[f])}return a}function n(a,b){var c=null;return function(){var d=this,e=arguments;clearTimeout(c),c=setTimeout(function(){a.apply(d,e)},b)}}function o(){return a.innerWidth===c?{height:a.document.documentElement.clientHeight,width:a.document.documentElement.clientWidth}:{height:a.innerHeight,width:a.innerWidth}}function p(a,b){if(!a.offsetParent){var c=r(b,"position");if("fixed"!==c)return!1}return!0}function q(b){return b.style===c?null:a.getComputedStyle(b,null)}function r(a,b){return a?a.getPropertyValue(b):c}function s(a,b){b||(b=q(a));var c=r(b,"display");if("none"===c)return!1;var d=r(b,"visibility");return"hidden"===d||"collapse"===d?!1:a.parentNode&&a.parentNode.style?s(a.parentNode,q(a)):!0}function t(a){if(a===b)return!0;if(!a||!a.parentNode)return!1;var c=q(a);if(!p(a,c))return!1;var d=s(a,c);return d!==!0?!1:!0}function u(a,b){return!a||a.width<=0||a.height<=0?!1:a.bottom>0&&a.right>0&&a.top<b.height&&a.left<b.width}function v(a){if(!w())return 0;var b=a.getBoundingClientRect(),c=o();if(!u(b,c)||!t(a))return 0;var d=0,e=0;return b.top>=0?d=Math.min(b.height,c.height-b.top):b.bottom>0&&(d=Math.min(c.height,b.bottom)),b.left>=0?e=Math.min(b.width,c.width-b.left):b.right>0&&(e=Math.min(c.width,b.right)),Math.round(d*e/(b.height*b.width)*1e3)/1e3}function w(){return C?!b[C[0]]:!0}function x(a,b){if(!(this instanceof x))return new x(a,b);if(!l(a))throw new Error("not an element node");this._element=a,this._config=m(b,{fullyvisible:1,hidden:0})}function y(a,b){var c=a.state(),d=c.percentage;return d===b.percentage&&b.percentage===b.previous.percentage?b:c.hidden?x.VisState.hidden(d,b):c.fullyvisible?x.VisState.fullyvisible(d,b):x.VisState.visible(d,b)}function z(b,c){for(var d=Object.keys(b),e=0,f=d.length;f>e;e++)b[e].call(c||a)}function A(a,b){var c=this,d=m(b,{strategy:new A.Strategy.NoopStrategy});c._visobj=a,c._lastListenerId=-1,c._state={},c._listeners={},c._strategy=d.strategy,c._events=["update","hidden","visible","fullyvisible","percentagechange","visibilitychange"];for(var e=0,f=c._events.length;f>e;e++)d[c._events[e]]&&c.on(c._events[e],d[c._events[e]])}function B(a,b,c){return c&&c&&delete c.previous,function(a,b,c){return{code:a[0],state:a[1],percentage:b,previous:c,fullyvisible:a[0]===D.FULLY_VISIBLE[0],visible:a[0]===D.VISIBLE[0]||a===D.FULLY_VISIBLE[0],hidden:a[0]===D.HIDDEN[0]}}(a,b,c)}var C=function(a){for(var c="visibilitychange",d=[["hidden",c],["mozHidden","moz"+c],["webkitHidden","webkit"+c],["msHidden","ms"+c]],e=0,f=d.length;f>e;e++)if(b[d[e][0]]!==a)return d[e]}();x.prototype.state=function(){var a=this.percentage();return{percentage:a,hidden:a<=this._config.hidden,visible:a>this._config.hidden,fullyvisible:a>=this._config.fullyvisible}},x.prototype.percentage=function(){return v(this._element)},x.prototype.isFullyVisible=function(){return this.state().fullyvisible},x.prototype.isVisible=function(){return this.state().visible},x.prototype.isHidden=function(){return this.state().hidden},x.fn=x.prototype,x.of=function(a,b){return new x(a,b)},A.prototype.visobj=function(){return this._visobj},A.prototype.state=function(){return this._state},A.prototype.start=function(){return this._strategy.start(this),this},A.prototype.stop=function(){return this._strategy.stop(this)},A.prototype.use=function(a){this._strategy.stop(),this._strategy=a,this._strategy.start(this)},A.prototype.update=function(){this._state=y(this._visobj,this._state),z(this._listeners,this)},A.prototype.onUpdate=function(a){return k(a)?(this._lastListenerId+=1,this._listeners[this._lastListenerId]=a.bind(c,this),this._lastListenerId):-1},A.prototype.onVisibilityChange=function(a){var b=this;return this.onUpdate(function(){b._state.code!==b._state.previous.code&&a(b)})},A.prototype.onPercentageChange=function(a){var b=this;return this.onUpdate(function(){var c=b._state.percentage,d=b._state.previous.percentage;c!==d&&a(c,d,b)})},A.prototype.onVisible=function(a){var b=this;return b.onVisibilityChange(d(function(){return b._state.visible&&!b._state.previous.visible},a))},A.prototype.onFullyVisible=function(a){var b=this;return b.onVisibilityChange(d(function(){return b._state.fullyvisible},a))},A.prototype.onHidden=function(a){var b=this;return b.onVisibilityChange(d(function(){return b._state.hidden},a))},A.prototype.on=function(a,b){var c=this;switch(a){case"update":return c.onUpdate(b);case"hidden":return c.onHidden(b);case"visible":return c.onVisible(b);case"fullyvisible":return c.onFullyVisible(b);case"percentagechange":return c.onPercentageChange(b);case"visibilitychange":return c.onVisibilityChange(b)}return-1};var D={HIDDEN:[0,"hidden"],VISIBLE:[1,"visible"],FULLY_VISIBLE:[2,"fullyvisible"]};return A.Strategy=function(){},A.Strategy.prototype.start=function(){throw new Error("Strategy#start needs to be overridden.")},A.Strategy.prototype.stop=function(){throw new Error("Strategy#stop needs to be overridden.")},A.Strategy.NoopStrategy=function(){},A.Strategy.NoopStrategy.prototype=Object.create(A.Strategy.prototype),A.Strategy.NoopStrategy.prototype.start=function(a){a.update()},A.Strategy.NoopStrategy.prototype.stop=function(){},A.Strategy.PollingStrategy=function(a){this._config=m(a,{interval:1e3}),this._started=!1},A.Strategy.PollingStrategy.prototype=Object.create(A.Strategy.prototype),A.Strategy.PollingStrategy.prototype.start=function(a){var b=this;return d(!b._started,function(){b.stop(),b._update=function(){a.update()},addEventListener("visibilitychange",b._update),function c(){a.update(),b._timer=setTimeout(c,b._config.interval)}(),b._started=!0})(),b._started},A.Strategy.PollingStrategy.prototype.stop=function(){var a=this;return a._started?(clearTimeout(a._timer),removeEventListener("visibilitychange",a._update),a._started=!1,!0):!1},A.Strategy.EventStrategy=function(a){this._config=m(a,{debounce:30}),this._started=!1},A.Strategy.EventStrategy.prototype=Object.create(A.Strategy.prototype),A.Strategy.EventStrategy.prototype.start=function(a){var b=this;return d(!b._started,function(){b.stop(),b._update=n(function(){a.update()},b._config.debounce),addEventListener("visibilitychange",b._update),addEventListener("scroll",b._update),addEventListener("resize",b._update),b._update(),b._started=!0})(),this._started},A.Strategy.EventStrategy.prototype.stop=function(){var a=this;return a._started?(removeEventListener("resize",a._update),removeEventListener("scroll",a._update),removeEventListener("visibilitychange",a._update),a._started=!1,!0):!1},x.VisMon=A,x.fn.monitor=function(a){return new A(this,a)},x.VisState={hidden:function(a,b){return B(D.HIDDEN,a,b||{})},visible:function(a,b){return B(D.VISIBLE,a,b||{})},fullyvisible:function(a,b){return B(D.FULLY_VISIBLE,a,b||{})}},x.Utils={fireIf:d,noop:f,identity:g,isObject:j,isFunction:k,isElement:l,defaults:m,extend:e,now:h,defer:i,debounce:n,isPageVisible:w,percentage:v,isVisibleByStyling:t,_viewport:o,_isInViewport:u,_isDisplayed:s,_computedStyle:q,_styleProperty:r},x});